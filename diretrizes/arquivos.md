# üìã Plano de Execu√ß√£o Revisado - CRM Travel SaaS

## üéØ Fase 1: Funda√ß√£o, Arquitetura e Multi-Tenancy (2-3 semanas)

### Etapa 1.1: Configura√ß√£o Inicial do Projeto
- **Inicializar projeto** com Next.js 15 e configura√ß√µes TypeScript
- **Criar estrutura de pastas** seguindo padr√£o modular:
  - `app/(auth)/` - P√°ginas de autentica√ß√£o
  - `app/(app)/` - Aplica√ß√£o principal
  - `lib/actions/` - Server Actions centralizadas
  - `lib/validations/` - Schemas Zod
  - `lib/services/` - L√≥gica de neg√≥cio
  - `lib/db/schema/` - Schemas separados por dom√≠nio

### Etapa 1.2: Configura√ß√£o do Banco de Dados
- **Arquivo: `lib/db/drizzle.ts`** - Configura√ß√£o da conex√£o com PostgreSQL
- **Arquivo: `lib/db/schema/index.ts`** - Export agregado de todos os schemas
- **Arquivo: `lib/db/schema/auth.ts`** - Tabelas users, roles
- **Arquivo: `lib/db/schema/agency.ts`** - Tabelas agencies, agencySettings
- **Arquivo: `lib/db/schema/activity.ts`** - Tabela activityLogs com √≠ndices
- **Executar migra√ß√µes** iniciais para criar estrutura base

### Etapa 1.3: Sistema de Vari√°veis de Ambiente Tipadas
- **Arquivo: `lib/config/env.ts`** - Schema Zod para valida√ß√£o de environment variables
- **Arquivo: `.env.example`** - Template documentado de vari√°veis
- **Arquivo: `types/env.d.ts`** - Tipos TypeScript para process.env

### Etapa 1.4: Sistema de Tratamento de Erros
- **Arquivo: `lib/services/error-handler/index.ts`** - Classes de erro customizadas
- **Arquivo: `lib/services/error-handler/action-wrapper.ts`** - Wrapper para Server Actions
- **Arquivo: `lib/services/error-handler/api-wrapper.ts`** - Wrapper para API routes

### Etapa 1.5: Sistema de Valida√ß√£o Centralizado
- **Arquivo: `lib/validations/common.schema.ts`** - Valida√ß√µes brasileiras (CPF, CNPJ, telefone, CEP)
- **Arquivo: `lib/validations/auth.schema.ts`** - Schemas de autentica√ß√£o
- **Arquivo: `lib/validations/agency.schema.ts`** - Schemas de ag√™ncia

### Etapa 1.6: Sistema de Autentica√ß√£o
- **Arquivo: `lib/auth/session.ts`** - Gerenciamento de sess√µes JWT
- **Arquivo: `lib/auth/middleware.ts`** - Middleware de autentica√ß√£o
- **Arquivo: `lib/actions/auth/sign-up.ts`** - Action de registro com valida√ß√£o
- **Arquivo: `lib/actions/auth/sign-in.ts`** - Action de login com tratamento de erros
- **Arquivo: `lib/actions/auth/sign-out.ts`** - Action de logout
- **Arquivo: `app/(auth)/sign-up/page.tsx`** - UI de registro
- **Arquivo: `app/(auth)/sign-in/page.tsx`** - UI de login

### Etapa 1.7: Sistema de Activity Logs
- **Arquivo: `lib/services/activity-logger/index.ts`** - Servi√ßo de logging com captura de IP/User-Agent
- **Arquivo: `lib/db/queries/activity.ts`** - Queries otimizadas para logs
- **Arquivo: `app/(app)/settings/activity/page.tsx`** - UI de visualiza√ß√£o de logs

### Etapa 1.8: Multi-tenancy e Isolamento
- **Arquivo: `lib/db/queries/index.ts`** - Queries base com isolamento por agencyId
- **Arquivo: `lib/middleware/tenant-isolation.ts`** - Middleware para garantir isolamento
- **Arquivo: `lib/db/cached-queries.ts`** - Sistema de cache com revalida√ß√£o

### Etapa 1.9: Dashboard e Layout Base
- **Arquivo: `app/(app)/layout.tsx`** - Layout principal com navega√ß√£o
- **Arquivo: `app/(app)/dashboard/page.tsx`** - Dashboard com m√©tricas
- **Arquivo: `components/ui/`** - Componentes base do shadcn/ui

## üèóÔ∏è Fase 2: M√≥dulos de Configura√ß√£o da Ag√™ncia (2 semanas)

### Etapa 2.1: Gest√£o de Usu√°rios (RF26, RF27)
- **Arquivo: `lib/validations/user.schema.ts`** - Valida√ß√µes de usu√°rio com roles
- **Arquivo: `lib/actions/users/create.ts`** - Action para criar usu√°rios com permiss√µes
- **Arquivo: `lib/actions/users/update.ts`** - Action para atualizar usu√°rios
- **Arquivo: `lib/actions/users/delete.ts`** - Soft delete de usu√°rios
- **Arquivo: `lib/services/permissions/index.ts`** - Sistema de permiss√µes granular
- **Arquivo: `app/(app)/settings/users/page.tsx`** - Listagem de usu√°rios
- **Arquivo: `app/(app)/settings/users/new/page.tsx`** - Formul√°rio de novo usu√°rio
- **Arquivo: `app/(app)/settings/users/[id]/edit/page.tsx`** - Edi√ß√£o de usu√°rio

### Etapa 2.2: Sistema de Funis de Venda (RF06-RF09)
- **Arquivo: `lib/validations/funnel.schema.ts`** - Valida√ß√µes de funis e est√°gios
- **Arquivo: `lib/db/schema/sales.ts`** - Tabelas salesFunnels, salesFunnelStages
- **Arquivo: `lib/actions/funnels/create.ts`** - Criar funil com est√°gios
- **Arquivo: `lib/actions/funnels/update.ts`** - Atualizar funil e reordenar est√°gios
- **Arquivo: `lib/actions/funnels/set-default.ts`** - Definir funil padr√£o
- **Arquivo: `lib/db/queries/funnels.ts`** - Queries com agrega√ß√£o de est√°gios
- **Arquivo: `app/(app)/funnels/page.tsx`** - Board Kanban principal
- **Arquivo: `app/(app)/funnels/settings/page.tsx`** - Configura√ß√£o de funis
- **Arquivo: `components/funnels/funnel-board.tsx`** - Componente drag-and-drop

### Etapa 2.3: Cat√°logo de Produtos Base (RF10-RF12)
- **Arquivo: `lib/validations/base-item.schema.ts`** - Valida√ß√µes com campos din√¢micos
- **Arquivo: `lib/db/schema/catalog.ts`** - Tabelas baseItems, baseItemFields
- **Arquivo: `lib/actions/base-items/create.ts`** - Criar item com campos customizados
- **Arquivo: `lib/actions/base-items/update.ts`** - Atualizar item e campos
- **Arquivo: `lib/services/dynamic-fields/index.ts`** - Gerenciador de campos din√¢micos
- **Arquivo: `app/(app)/catalog/page.tsx`** - Listagem de itens base
- **Arquivo: `app/(app)/catalog/new/page.tsx`** - Criar novo item
- **Arquivo: `components/dynamic-fields/field-builder.tsx`** - UI para campos customizados

### Etapa 2.4: Gest√£o de Operadoras (RF13-RF16)
- **Arquivo: `lib/validations/operator.schema.ts`** - Valida√ß√µes de operadora
- **Arquivo: `lib/db/schema/operators.ts`** - Tabelas operators, operatorItems
- **Arquivo: `lib/actions/operators/create.ts`** - Criar operadora
- **Arquivo: `lib/actions/operators/associate-items.ts`** - Associar itens base
- **Arquivo: `lib/actions/operators/set-commissions.ts`** - Definir comiss√µes por pagamento
- **Arquivo: `lib/services/commission/calculator.ts`** - Calculadora de comiss√µes
- **Arquivo: `app/(app)/operators/page.tsx`** - Listagem de operadoras
- **Arquivo: `app/(app)/operators/[id]/items/page.tsx`** - Gerenciar portf√≥lio
- **Arquivo: `components/operators/commission-table.tsx`** - Tabela de comiss√µes

## üíº Fase 3: Core do CRM - Clientes e Propostas (3 semanas)

### Etapa 3.1: Gest√£o Completa de Clientes (RF01-RF05)
- **Arquivo: `lib/validations/client.schema.ts`** - Valida√ß√µes PF/PJ com documentos BR
- **Arquivo: `lib/db/schema/clients.ts`** - Tabelas clients, interactions, tasks
- **Arquivo: `lib/actions/clients/create.ts`** - Criar cliente com funil padr√£o
- **Arquivo: `lib/actions/clients/update.ts`** - Atualizar dados do cliente
- **Arquivo: `lib/actions/clients/transfer.ts`** - Transferir cliente entre agentes
- **Arquivo: `lib/actions/clients/bulk-import.ts`** - Importa√ß√£o em massa
- **Arquivo: `lib/db/queries/clients.ts`** - Queries com filtros avan√ßados
- **Arquivo: `lib/services/client-enrichment/index.ts`** - Enriquecimento de dados
- **Arquivo: `app/(app)/clients/page.tsx`** - Listagem com filtros
- **Arquivo: `app/(app)/clients/new/page.tsx`** - Formul√°rio inteligente PF/PJ
- **Arquivo: `app/(app)/clients/[id]/page.tsx`** - Perfil completo do cliente
- **Arquivo: `app/(app)/clients/import/page.tsx`** - Interface de importa√ß√£o
- **Arquivo: `components/clients/interaction-timeline.tsx`** - Timeline de intera√ß√µes
- **Arquivo: `components/clients/task-manager.tsx`** - Gerenciador de tarefas

### Etapa 3.2: Sistema de Propostas (RF17-RF21)
- **Arquivo: `lib/validations/proposal.schema.ts`** - Valida√ß√µes de proposta
- **Arquivo: `lib/db/schema/proposals.ts`** - Tabelas proposals, proposalItems
- **Arquivo: `lib/actions/proposals/create.ts`** - Criar proposta draft
- **Arquivo: `lib/actions/proposals/add-item.ts`** - Adicionar produto com c√°lculo
- **Arquivo: `lib/actions/proposals/update-status.ts`** - M√°quina de estados
- **Arquivo: `lib/services/proposal/state-machine.ts`** - Estados e transi√ß√µes
- **Arquivo: `lib/services/proposal/calculator.ts`** - C√°lculo de totais e margens
- **Arquivo: `lib/services/pdf/proposal-generator.ts`** - Gerador de PDF
- **Arquivo: `app/(app)/proposals/page.tsx`** - Listagem de propostas
- **Arquivo: `app/(app)/proposals/new/page.tsx`** - Wizard de cria√ß√£o
- **Arquivo: `app/(app)/proposals/[id]/edit/page.tsx`** - Editor de proposta
- **Arquivo: `app/(app)/proposals/[id]/preview/page.tsx`** - Preview do PDF
- **Arquivo: `components/proposals/item-selector.tsx`** - Seletor de produtos
- **Arquivo: `components/proposals/dynamic-form.tsx`** - Formul√°rio campos customizados

## üìä Fase 4: P√≥s-Venda e Financeiro (2.5 semanas)

### Etapa 4.1: Gest√£o de Reservas (RF22-RF25)
- **Arquivo: `lib/validations/reservation.schema.ts`** - Valida√ß√µes de reserva
- **Arquivo: `lib/db/schema/reservations.ts`** - Tabelas reservations, documents
- **Arquivo: `lib/actions/reservations/create-from-proposal.ts`** - Convers√£o autom√°tica
- **Arquivo: `lib/actions/reservations/update-status.ts`** - Atualizar status
- **Arquivo: `lib/actions/reservations/attach-document.ts`** - Upload de documentos
- **Arquivo: `lib/services/storage/document-manager.ts`** - Gerenciador de arquivos
- **Arquivo: `app/(app)/reservations/page.tsx`** - Dashboard de reservas
- **Arquivo: `app/(app)/reservations/[id]/page.tsx`** - Detalhes da reserva
- **Arquivo: `components/reservations/status-tracker.tsx`** - Rastreador de status
- **Arquivo: `components/reservations/document-gallery.tsx`** - Galeria de documentos

### Etapa 4.2: Sistema Financeiro (RF28-RF32)
- **Arquivo: `lib/validations/financial.schema.ts`** - Valida√ß√µes financeiras
- **Arquivo: `lib/db/schema/financial.ts`** - Tabelas financialRecords, commissions
- **Arquivo: `lib/actions/financial/create-transaction.ts`** - Lan√ßamentos manuais
- **Arquivo: `lib/actions/financial/process-payment.ts`** - Processar pagamentos
- **Arquivo: `lib/actions/financial/calculate-commissions.ts`** - Calcular comiss√µes
- **Arquivo: `lib/services/financial/cash-flow.ts`** - Gerador de fluxo de caixa
- **Arquivo: `lib/services/financial/reports.ts`** - Gerador de relat√≥rios
- **Arquivo: `app/(app)/financial/receivables/page.tsx`** - Contas a receber
- **Arquivo: `app/(app)/financial/payables/page.tsx`** - Contas a pagar
- **Arquivo: `app/(app)/financial/cash-flow/page.tsx`** - Fluxo de caixa
- **Arquivo: `app/(app)/financial/reports/page.tsx`** - DRE simplificado
- **Arquivo: `components/financial/charts.tsx`** - Gr√°ficos com Recharts

## üîî Fase 5: M√≥dulos de Suporte (2 semanas)

### Etapa 5.1: Sistema de Notifica√ß√µes (RF37-RF39)
- **Arquivo: `lib/db/schema/notifications.ts`** - Tabela notifications
- **Arquivo: `lib/services/notification/manager.ts`** - Gerenciador de notifica√ß√µes
- **Arquivo: `lib/services/notification/email-sender.ts`** - Integra√ß√£o email (Resend)
- **Arquivo: `lib/services/notification/push-sender.ts`** - Push notifications
- **Arquivo: `lib/actions/notifications/mark-read.ts`** - Marcar como lida
- **Arquivo: `app/(app)/notifications/page.tsx`** - Central de notifica√ß√µes
- **Arquivo: `app/(app)/settings/notifications/page.tsx`** - Prefer√™ncias
- **Arquivo: `components/notifications/bell.tsx`** - Componente sino
- **Arquivo: `components/notifications/toast-provider.tsx`** - Provider de toasts

### Etapa 5.2: Auditoria e Logs (RF33-RF36)
- **Arquivo: `lib/db/schema/audit.ts`** - Tabela logs expandida
- **Arquivo: `lib/services/audit/logger.ts`** - Logger avan√ßado com contexto
- **Arquivo: `lib/middleware/audit-middleware.ts`** - Middleware de auditoria
- **Arquivo: `app/(app)/admin/audit/page.tsx`** - Visualizador de logs
- **Arquivo: `components/audit/log-viewer.tsx`** - Componente de visualiza√ß√£o
- **Arquivo: `components/audit/filters.tsx`** - Filtros avan√ßados

### Etapa 5.3: Otimiza√ß√µes e PWA
- **Arquivo: `lib/services/cache/manager.ts`** - Gerenciador de cache
- **Arquivo: `lib/services/performance/monitor.ts`** - Monitor de performance
- **Arquivo: `public/manifest.json`** - Manifest PWA
- **Arquivo: `public/service-worker.js`** - Service worker para offline
- **Arquivo: `app/(app)/settings/preferences/page.tsx`** - Prefer√™ncias do usu√°rio

## üß™ Fase 6: Testes e Deploy (Cont√≠nuo)

### Etapa 6.1: Configura√ß√£o de Testes
- **Arquivo: `jest.config.js`** - Configura√ß√£o Jest
- **Arquivo: `playwright.config.ts`** - Configura√ß√£o E2E
- **Arquivo: `__tests__/unit/`** - Testes unit√°rios
- **Arquivo: `__tests__/integration/`** - Testes de integra√ß√£o
- **Arquivo: `__tests__/e2e/`** - Testes end-to-end

### Etapa 6.2: CI/CD e Monitoramento
- **Arquivo: `.github/workflows/ci.yml`** - Pipeline de CI
- **Arquivo: `.github/workflows/deploy.yml`** - Pipeline de deploy
- **Arquivo: `docker-compose.yml`** - Ambiente de desenvolvimento
- **Arquivo: `vercel.json`** - Configura√ß√£o de deploy
- **Arquivo: `lib/services/monitoring/sentry.ts`** - Integra√ß√£o Sentry

## üìà Cronograma Estimado

- **Fase 1**: 2-3 semanas (Funda√ß√£o s√≥lida)
- **Fase 2**: 2 semanas (Configura√ß√µes base)
- **Fase 3**: 3 semanas (Core do CRM)
- **Fase 4**: 2.5 semanas (Financeiro)
- **Fase 5**: 2 semanas (Suporte)
- **Fase 6**: Cont√≠nuo durante todo o projeto

**Total**: ~12 semanas para MVP completo

## üéØ Pontos de Verifica√ß√£o

Ap√≥s cada fase, validar:
1. ‚úÖ Todos os testes passando
2. ‚úÖ Cobertura de c√≥digo > 70%
3. ‚úÖ Performance dentro dos limites (LCP < 2.5s, API < 500ms)
4. ‚úÖ Sem vulnerabilidades de seguran√ßa
5. ‚úÖ Documenta√ß√£o atualizada
6. ‚úÖ Deploy em staging funcionando